'use strict';
var path = require('path');
var _ = require('underscore');
var async = require('async');
var recess = require('recess');

var plugin = module.exports = Plugin.create('plugin-recess');

plugin.run = function(project, callback) {
  var that = this;
  var build = project.buildDirectory;
  var hasError = false;
  var cssFiles = fsExt.listFiles(build, /\.css$/);
     
  async.forEach(cssFiles, function(f, cb) {
    recess(f, that.config, function(err, obj) {
      if (err) {
        console.error(that.name + ' 发现 css 错误');
        obj.errors.forEach(function(err) {
          console.info();
          console.error("css " + err.filename + " " + err.type + "error : " + err.message);
          console.error("line:" + err.line);
          console.error("extract:" + err.extract);
          console.info();
        });
        hasError = true;
      } else {
        if (obj.output.length > 2) {
          // 发现检查问题
          console.info();
          console.warn('  ' + that.name + ' 检查结果')
          console.info();
          obj.output.forEach(function(item) {
            console.info('  ' + item);    
          });
        }
      }
      cb();
    }); 
  }, function() {
    if (hasError) {
      callback(that.name + ' 发现 css 严重错误, 请根据上面提示信息,解决此错误后在继续编译!');
    } else {
      callback();
    }
  });
};
